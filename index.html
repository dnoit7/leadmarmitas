<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteador de Times — Pelada</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --muted:#6b7280;
      --accent:#0ea5e9;
      --success:#10b981;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:#0b1724;
      padding:18px;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{ max-width:820px;margin:0 auto; }
    .card{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 6px 18px rgba(2,6,23,0.06); margin-bottom:14px; }
    h1{ text-align:center; margin:8px 0 14px;font-size:22px }
    label.small{ font-size:13px; color:var(--muted) }
    textarea.form{ width:100%; min-height:120px; padding:10px; border-radius:10px; border:1px solid rgba(2,6,23,0.06); resize:vertical; font-size:15px }
    .btn{ display:inline-block; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; font-size:15px }
    .btn-primary{ background:var(--accent); color:#042; }
    .btn-ghost{ background:transparent;border:1px solid rgba(2,6,23,0.06); color:var(--muted) }
    .btn-warn{ background:#f59e0b;color:#042 }
    .btn-success{ background:var(--success); color:#042 }
    .btn-danger{ background:var(--danger); color:#fff }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .players{ margin-top:8px }
    .player-row{ display:flex; gap:8px; align-items:center; padding:8px 4px; border-radius:8px; background:rgba(2,6,23,0.01); margin-bottom:8px }
    .player-row input[type="text"]{ flex:1; padding:8px; border-radius:8px; border:1px solid rgba(2,6,23,0.06); font-size:15px }
    .player-row select{ width:96px; padding:8px; border-radius:8px; border:1px solid rgba(2,6,23,0.06) }
    .player-row .small-btn{ padding:6px 8px; font-size:13px; border-radius:8px; border:1px solid rgba(2,6,23,0.06); background:transparent; cursor:pointer }
    .teams-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-top:12px }
    .team-card{ background:linear-gradient(180deg,rgba(255,255,255,0.99),rgba(255,255,255,0.96)); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04) }
    pre#result{ white-space:pre-wrap; background:rgba(14,165,233,0.04); padding:12px; border-radius:8px; font-size:15px }
    .muted{ color:var(--muted); font-size:13px }
    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:8px }

    /* MOBILE tweaks */
    @media(max-width:640px){
      .player-row{ display:block }
      .player-row input[type="text"], .player-row select { width:100%; margin-bottom:8px }
      .row { flex-direction:column; }
      .btn{ width:100% }
      .teams-grid{ grid-template-columns:1fr; }
      textarea.form{ min-height:160px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sorteador de Times — Pelada</h1>

    <!-- IMPORT -->
    <div class="card" id="importCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>1) Cole a lista do WhatsApp</strong>
        <span class="muted small">Ex: <code>1 - Fulano</code></span>
      </div>

      <div style="margin-top:8px">
        <textarea id="rawInput" class="form" placeholder="Cole aqui a conversa/lista do grupo (ex.: 1 - João)"></textarea>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="btnImport">Importar lista</button>
        <button class="btn btn-ghost" id="btnClearInput">Limpar entrada</button>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label class="small muted" style="margin-right:6px">Times</label>
          <select id="teamsCount" style="padding:8px;border-radius:8px;border:1px solid rgba(2,6,23,0.06)">
            <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </div>
      </div>
    </div>

    <!-- PLAYERS -->
    <div class="card" id="playersCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>2) Jogadores</strong>
        <span class="muted">Marque quem vai e atribua nível</span>
      </div>

      <div id="playersList" class="players" style="margin-top:10px">
        <div class="muted">Nenhum jogador importado ainda.</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-success" id="btnDraw">Gerar times</button>
        <button class="btn btn-primary" id="btnCopy">Copiar Times p/ WhatsApp</button>
        <button class="btn btn-ghost" id="btnClear">Limpar lista</button>
        <button class="btn btn-danger" id="btnClearResult">Limpar resultado</button>
      </div>

      <div style="margin-top:10px" id="summary" class="muted">0 jogadores</div>
    </div>

    <!-- RESULT -->
    <div class="card">
      <strong>3) Times Gerados</strong>
      <div id="teamsContainer" class="teams-grid" style="margin-top:10px">
        <!-- Filled dynamically -->
      </div>

      <div style="margin-top:10px">
        <pre id="result" style="display:none"></pre>
      </div>
    </div>

    <footer>Salve o arquivo localmente ou publique no GitHub Pages — funciona offline.</footer>
  </div>

<script>
/* --- Utilities and storage --- */
const LS_KEY = 'sorteador_players_v2';
let players = []; // {id,name,level,selected}

const $ = id => document.getElementById(id);

/* Unicode-robust emoji removal with fallback */
function removeEmojis(str){
  if(!str) return '';
  try {
    // modern engines
    return String(str).replace(/[\p{Extended_Pictographic}\p{Emoji_Presentation}\uFE0F]/gu, '');
  } catch(e){
    // fallback ranges (not perfect but works on older engines)
    return String(str).replace(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu, '');
  }
}

/* Normalize line endings and clean line */
function cleanLine(line){
  // remove carriage returns, trim
  let s = String(line).replace(/\r/g,'').trim();
  // remove leading numbers and separators: "1 -", "2)", "3."
  s = s.replace(/^\s*\d+\s*[\-–\.\)]*\s*/, '');
  // remove emojis
  s = removeEmojis(s);
  // collapse extra spaces
  s = s.replace(/\s+/g,' ').trim();
  return s;
}

/* load/save */
function loadPlayers(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    players = raw ? JSON.parse(raw) : [];
  }catch(e){ players = [] }
}
function savePlayers(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(players)); }catch(e){} }

/* render players UI */
function renderPlayers(){
  const container = $('playersList');
  container.innerHTML = '';
  if(players.length === 0){
    container.innerHTML = '<div class="muted">Nenhum jogador importado ainda.</div>';
    updateSummary();
    return;
  }

  players.forEach((p, idx) => {
    const row = document.createElement('div');
    row.className = 'player-row';

    // checkbox
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = p.selected !== false;
    chk.style.width='20px'; chk.style.height='20px';
    chk.addEventListener('change', ()=> { p.selected = chk.checked; savePlayers(); updateSummary(); });

    // name input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = p.name;
    nameInput.placeholder = 'Nome';
    nameInput.addEventListener('change', ()=> { p.name = nameInput.value.trim(); savePlayers(); });

    // level select
    const lvl = document.createElement('select');
    lvl.innerHTML = '<option value="1">1 ⭐</option><option value="2">2 ⭐⭐</option><option value="3">3 ⭐⭐⭐</option><option value="4">4 ⭐⭐⭐⭐</option><option value="5">5 ⭐⭐⭐⭐⭐</option>';
    lvl.value = p.level || 3;
    lvl.addEventListener('change', ()=> { p.level = parseInt(lvl.value||3); savePlayers(); });

    // delete button
    const del = document.createElement('button');
    del.className = 'small-btn';
    del.textContent = 'Apagar';
    del.addEventListener('click', ()=> {
      if(!confirm('Apagar jogador?')) return;
      players = players.filter(x=>x.id !== p.id);
      savePlayers();
      renderPlayers();
    });

    // assemble
    // For desktop: inline; mobile media CSS will stack
    row.appendChild(chk);
    row.appendChild(nameInput);
    row.appendChild(lvl);
    row.appendChild(del);

    container.appendChild(row);
  });

  updateSummary();
}

/* update summary text */
function updateSummary(){
  const total = players.length;
  const sel = players.filter(p=>p.selected).length;
  $('summary').textContent = `${total} jogadores cadastrados • ${sel} selecionados`;
}

/* import from textarea */
function importFromText(){
  const raw = $('rawInput').value || '';
  if(!raw.trim()){ alert('Cole a lista primeiro.'); return; }

  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const extracted = [];
  for(const line of lines){
    const cleaned = cleanLine(line);
    if(cleaned) extracted.push(cleaned);
  }

  // dedupe case-insensitive preserving order
  const seen = new Set();
  const unique = [];
  for(const n of extracted){
    const key = n.toLowerCase();
    if(!seen.has(key)){ seen.add(key); unique.push(n); }
  }

  // push to players with defaults
  unique.forEach(n => players.push({ id: Date.now().toString(36) + Math.random().toString(36).slice(2,6), name:n, level:3, selected:true }));

  savePlayers();
  renderPlayers();
}

/* clear raw input */
function clearRawInput(){ $('rawInput').value = ''; }

/* clear list entirely */
function clearAll(){
  if(!confirm('Limpar todos os jogadores e resultados?')) return;
  players = [];
  savePlayers();
  renderPlayers();
  $('result').style.display='none';
  $('result').textContent='';
  $('teamsContainer').innerHTML='';
}

/* distribution algorithm (serpentine by levels) */
function distributeBalanced(selectedPlayers, teamsCount, shuffleSame=true){
  const grouped = {};
  selectedPlayers.forEach(p=>{
    const lvl = p.level || 3;
    if(!grouped[lvl]) grouped[lvl]=[];
    grouped[lvl].push(p);
  });
  const levels = Object.keys(grouped).map(Number).sort((a,b)=>b-a); // high->low
  if(shuffleSame){
    for(const l of levels) grouped[l] = shuffleArray(grouped[l]);
  }
  const ordered = [];
  levels.forEach(l => ordered.push(...grouped[l]));

  const teams = Array.from({length: teamsCount}, ()=>[]);
  let forward = true;
  for(let i=0;i<ordered.length;i++){
    const pos = forward ? (i % teamsCount) : (teamsCount - 1 - (i % teamsCount));
    teams[pos].push(ordered[i]);
    if((i+1) % teamsCount === 0) forward = !forward;
  }
  return teams;
}

function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* render teams */
function renderTeams(teams){
  const container = $('teamsContainer');
  container.innerHTML = '';
  if(!teams || teams.length===0) {
    $('result').style.display='none';
    $('result').textContent='';
    return;
  }
  teams.forEach((t, i)=>{
    const card = document.createElement('div');
    card.className = 'team-card';
    const total = t.reduce((s,p)=>s + (p.level||0), 0);
    let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Time ${i+1}</strong><span class="muted">Força: ${total}</span></div><ul style="padding-left:14px;margin:0">`;
    t.forEach(p=> html += `<li style="margin-bottom:6px">${p.name}</li>`);
    html += '</ul>';
    card.innerHTML = html;
    container.appendChild(card);
  });

  // also fill plain text result for copy
  let text = '';
  teams.forEach((t,i)=>{
    text += `⚽ Time ${i+1}:\n`;
    t.forEach(p=> text += `• ${p.name}\n`);
    text += '\n';
  });
  const res = $('result');
  res.style.display='block';
  res.textContent = text.trim();
}

/* copy to clipboard (only names) */
async function copyToWhatsApp(){
  const text = $('result').textContent || '';
  if(!text.trim()){ alert('Gere os times primeiro!'); return; }
  try{
    await navigator.clipboard.writeText(text);
    alert('Times copiados! Agora cole no WhatsApp.');
  }catch(e){
    // fallback: select text
    alert('Não foi possível copiar automaticamente. Selecione e copie manualmente.');
  }
}

/* MAIN: generate teams from selected players */
function generate(){
  const count = parseInt($('teamsCount').value) || 2;
  const selected = players.filter(p=>p.selected);
  if(selected.length < count){ alert('Número de jogadores selecionados menor que o número de times'); return; }
  const teams = distributeBalanced(selected, count, true);
  renderTeams(teams);
}

/* INIT & events */
document.addEventListener('DOMContentLoaded', ()=> {
  loadPlayers();
  renderPlayers();

  // buttons
  $('btnImport').addEventListener('click', importFromText);
  $('btnClearInput').addEventListener('click', clearRawInput);
  $('btnClear').addEventListener('click', clearAll);
  $('btnDraw').addEventListener('click', generate);
  $('btnCopy').addEventListener('click', copyToWhatsApp);
  $('btnClearResult').addEventListener('click', ()=>{ $('result').textContent=''; $('result').style.display='none'; $('teamsContainer').innerHTML=''; });

  // keyboard: ctrl+enter on textarea -> import
  $('rawInput').addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='Enter'){ importFromText(); }});
});
</script>
</body>
</html>
